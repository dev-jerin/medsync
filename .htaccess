# ----------------------------------------------------------------------
# MedSync Apache Configuration v2.2 - For Local Development
# ----------------------------------------------------------------------

# Turn on the rewrite engine
RewriteEngine On

# Set the base path to match the one in your config.php
RewriteBase /medsync/

# ----------------------------------------------------------------------
# Section 1: Canonical URLs
# ----------------------------------------------------------------------

# Remove trailing slash from non-directories
# This rule is now more explicit to prevent incorrect redirects.
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /medsync/$1 [R=301,L]

# Remove index.php from the URL
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s(.*)/index\.php [NC]
RewriteRule ^ %1/ [R=301,L]

# Add .php extension to files
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [L]

# ----------------------------------------------------------------------
# Section 2: Maintenance Mode (with correct 503 status)
# ----------------------------------------------------------------------
# To enable, create an empty ".maintenance" file in your root directory.
RewriteCond %{DOCUMENT_ROOT}/medsync/.maintenance -f

# Allow access to the 503 page itself and its assets
RewriteCond %{REQUEST_URI} !/medsync/error/503\.php$
RewriteCond %{REQUEST_URI} !/medsync/error/styles\.css$
RewriteCond %{REQUEST_URI} !/medsync/images/

# Send a 503 Service Unavailable header, then show the 503 page.
RewriteRule ^.*$ /medsync/error/503.php [R=503,L]

# ----------------------------------------------------------------------
# Section 3: PHP Error Logging & Security for Development
# ----------------------------------------------------------------------
# Display errors for easier debugging on local server
php_flag display_errors on
php_flag log_errors on
php_value error_log log.txt

# Secure the log file from being accessed via browser
<Files "log.txt">
    Require all denied
</Files>

# ----------------------------------------------------------------------
# Section 4: Custom Error Documents
# ----------------------------------------------------------------------
ErrorDocument 404 /medsync/error/404.php
ErrorDocument 403 /medsync/error/403.php
ErrorDocument 500 /medsync/error/500.php
ErrorDocument 503 /medsync/error/503.php

# ----------------------------------------------------------------------
# Section 5: Directory Listing
# ----------------------------------------------------------------------
# Prevent directory listing
Options -Indexes