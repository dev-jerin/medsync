# ----------------------------------------------------------------------
# MedSync Apache Configuration v2.4 - For Local Development
# ----------------------------------------------------------------------

RewriteEngine On

# Set the base path for your project.
# This assumes the .htaccess file is in the /medsync/ directory.
RewriteBase /medsync/

# ----------------------------------------------------------------------
# Section 1: Security & Core Directives
# ----------------------------------------------------------------------

# Prevent directory listing for security
Options -Indexes

# Prevent content negotiation issues that can interfere with rewrites
Options -MultiViews

# ----------------------------------------------------------------------
# Section 2: Rewrite Rules
# ----------------------------------------------------------------------

# Rule 1: Remove trailing slashes from URLs that are not actual directories
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ $1 [R=301,L]

# Rule 2 (NEW): Explicitly block requests with extra path info after a .php file.
# This is a key part of the fix. It finds invalid URLs like "/dashboard.php/foo"
# and immediately triggers a 404 error, preventing the 500 error.
RewriteCond %{THE_REQUEST} \.php/
RewriteRule .? - [R=404,L]

# Rule 3 (IMPROVED): Add the .php extension for clean URLs.
# This is now safer and prevents rewrite loops.
# - It won't apply to existing files or directories.
# - Most importantly, it checks if the .php file actually exists before rewriting.
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/medsync/$1.php -f
RewriteRule ^(.*)$ $1.php [L]

# ----------------------------------------------------------------------
# Section 3: Custom Error Documents
# ----------------------------------------------------------------------
# Using absolute paths from the web root is more reliable and avoids rewrite loops.
ErrorDocument 404 /medsync/error/404.php
ErrorDocument 403 /medsync/error/403.php
ErrorDocument 500 /medsync/error/500.php
ErrorDocument 503 /medsync/error/503.php

# ----------------------------------------------------------------------
# Section 4: Maintenance Mode
# ----------------------------------------------------------------------
RewriteCond %{DOCUMENT_ROOT}/medsync/.maintenance -f
RewriteCond %{REQUEST_URI} !^/medsync/error/503\.php$
RewriteRule ^.*$ /medsync/error/503.php [R=503,L]

# ----------------------------------------------------------------------
# Section 5: PHP Settings & Security for Development
# ----------------------------------------------------------------------
php_flag display_errors on
php_flag log_errors on
php_value error_log log.txt

<Files "log.txt">
    Require all denied
</Files>