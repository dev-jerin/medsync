# ----------------------------------------------------------------------
# MedSync Apache Configuration v2.4 - For Local Development
# ----------------------------------------------------------------------

RewriteEngine On

# Set the base path for your project.
# This assumes the .htaccess file is in the /medsync/ directory.
RewriteBase /medsync/

# ----------------------------------------------------------------------
# Section 1: Security & Core Directives
# ----------------------------------------------------------------------

# Prevent directory listing for security
Options -Indexes

# Prevent content negotiation issues that can interfere with rewrites
Options -MultiViews

# ----------------------------------------------------------------------
# Section 2: Rewrite Rules
# ----------------------------------------------------------------------

# Rule 1: Remove trailing slashes from URLs that are not actual directories
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ $1 [R=301,L]

# Rule 2 (NEW): Explicitly block requests with extra path info after a .php file.
# This is a key part of the fix. It finds invalid URLs like "/dashboard.php/foo"
# and immediately triggers a 404 error, preventing the 500 error.
RewriteCond %{THE_REQUEST} \.php/
RewriteRule .? - [R=404,L]

# Rule 3 (IMPROVED): Add the .php extension for clean URLs.
# This is now safer and prevents rewrite loops.
# - It won't apply to existing files or directories.
# - Most importantly, it checks if the .php file actually exists before rewriting.
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/medsync/$1.php -f
RewriteRule ^(.*)$ $1.php [L]

# ----------------------------------------------------------------------
# Section 3: Custom Error Documents
# ----------------------------------------------------------------------
# Using absolute paths from the web root is more reliable and avoids rewrite loops.
ErrorDocument 404 /medsync/error/404.php
ErrorDocument 403 /medsync/error/403.php
ErrorDocument 500 /medsync/error/500.php
ErrorDocument 503 /medsync/error/503.php

# ----------------------------------------------------------------------
# Section 4: Maintenance Mode
# ----------------------------------------------------------------------
RewriteCond %{DOCUMENT_ROOT}/medsync/.maintenance -f
RewriteCond %{REQUEST_URI} !^/medsync/error/503\.php$
RewriteRule ^.*$ /medsync/error/503.php [R=503,L]

# ----------------------------------------------------------------------
# Section 5: PHP Settings & Security for Development
# ----------------------------------------------------------------------
php_flag display_errors on
php_flag log_errors on
php_value error_log log.txt

<Files "log.txt">
    Require all denied
</Files>

# ----------------------------------------------------------------------
# Section 6: Protect Environment Variables
# ----------------------------------------------------------------------
# Deny access to .env files
<FilesMatch "^\.env">
    Require all denied
</FilesMatch>

# Deny access to sensitive configuration files
<FilesMatch "^(composer\.(json|lock)|\.git.*|\.env.*|firebase_credentials\.json)$">
    Require all denied
</FilesMatch>

# ----------------------------------------------------------------------
# Section 7: Block Direct Access to Sensitive Files
# ----------------------------------------------------------------------

# Block config files from being accessed directly
<FilesMatch "^(config\.php|firebase_config\.php|chatbot_config\.php|recaptcha_config\.php)$">
    Require all denied
</FilesMatch>

# Block database SQL files
<FilesMatch "\.(sql|db|sqlite|sqlite3)$">
    Require all denied
</FilesMatch>

# Block backup and temporary files
<FilesMatch "\.(bak|backup|tmp|temp|old|log|swp)$">
    Require all denied
</FilesMatch>

# Block version control and project files
<FilesMatch "^(\.git|\.gitignore|\.gitattributes|README\.md|CONTRIBUTING\.md|CODE_OF_CONDUCT\.md|LICENSE|lic-header\.txt)$">
    Require all denied
</FilesMatch>

# Block Composer and package manager files
<FilesMatch "^(composer\.json|composer\.lock|package\.json|package-lock\.json)$">
    Require all denied
</FilesMatch>

# ----------------------------------------------------------------------
# Section 8: Protect Specific Directories
# ----------------------------------------------------------------------

# Block access to vendor directory (Composer packages)
RedirectMatch 403 ^/medsync/vendor/.*$

# Block access to _private directory (already has its own .htaccess)
RedirectMatch 403 ^/medsync/_private/.*$

# Block access to docs directory (optional - uncomment if needed)
# RedirectMatch 403 ^/medsync/docs/.*$


